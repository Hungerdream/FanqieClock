# 番茄钟程序测试与优化计划 (Test & Optimization Plan)

## 1. 测试目标
全面评估现有番茄钟程序的性能、稳定性、功能完整性和用户体验，识别潜在缺陷并进行针对性修复，确保交付高质量的桌面应用程序。

## 2. 测试范围

### 2.1 功能测试 (Functional Testing)
- **计时器核心逻辑**:
  - [ ] 倒计时准确性验证 (与系统时钟对比)
  - [ ] 状态流转 (专注 -> 休息 -> 长休息)
  - [ ] 暂停/恢复/放弃功能
  - [ ] 强制长休息触发机制 (4个番茄后)
- **任务管理 (四象限)**:
  - [ ] 任务添加、删除、编辑
  - [ ] 拖拽排序与象限移动
  - [ ] 任务与计时器的绑定 (专注任务记录)
  - [ ] 任务番茄数统计准确性
- **数据持久化**:
  - [ ] 数据自动保存 (任务变动、计时结束)
  - [ ] 程序重启后数据恢复
  - [ ] 异常关闭下的数据完整性 (原子写入验证)
  - [ ] 加密/解密正确性

### 2.2 性能测试 (Performance Testing)
- **响应速度**:
  - [ ] 启动时间 (< 2秒)
  - [ ] 界面切换延迟 (< 100ms)
  - [ ] 任务拖拽流畅度 (60fps)
- **资源占用**:
  - [ ] 内存泄漏检测 (长时间运行后内存增长)
  - [ ] CPU 占用率 (计时状态下 < 5%)
- **I/O 性能**:
  - [ ] 数据保存时的 UI 阻塞情况 (目标: 无感知)

### 2.3 用户体验测试 (UX Testing)
- **交互流程**:
  - [ ] 快捷键响应
  - [ ] 悬浮窗/主窗口切换动画
  - [ ] 通知提示 (Toast/Tray)
- **视觉反馈**:
  - [ ] 进度条动画平滑度
  - [ ] 遮罩层 (长休息) 显示效果
- **异常处理**:
  - [ ] 磁盘写保护时的错误提示
  - [ ] 网络超时 (每日一句) 的降级处理

## 3. 已识别问题与修复方案 (Optimization Roadmap)

| 优先级 | 问题描述 | 影响 | 修复方案 |
| :--- | :--- | :--- | :--- |
| **P0** | **主线程 I/O 阻塞** | 保存数据时 UI 卡顿，特别是数据量大时 | **代码重构**: 引入 `QRunnable`/`QThreadPool` 实现异步保存，将加密与写文件移出主线程。 |
| **P0** | **加密算法低效** | 纯 Python 字符循环效率低，加剧卡顿 | **算法优化**: 改用 `bytes` 操作与 `itertools` 优化 XOR 性能，或仅在必要时加密。 |
| **P1** | **错误处理缺失** | 保存失败无提示，数据默默丢失 | **增强健壮性**: `DataManager` 增加信号机制，保存失败时弹出 `QMessageBox` 警告用户。 |
| **P1** | **线程频繁创建** | 每次播放声音都 Spawn 新线程，资源浪费 | **资源复用**: 使用 `QThreadPool` 全局实例或单例 Worker 处理音效。 |
| **P2** | **悬浮窗动画丢失** | 代码中注释移除了动画，体验生硬 | **Bug 修复**: 检查 `ui/floating_window.py`，修复导致 `AttributeError` 的动画逻辑并恢复。 |
| **P2** | **长休息引导交互** | 遮罩层可能过于强硬，缺乏紧急退出机制 | **体验优化**: 增加“紧急解锁”按钮 (需长按)，防止误操作同时也提供灵活性。 |

## 4. 测试工具与方法
- **单元测试**: `unittest` (已集成)
- **性能分析**: `cProfile` (Python 内置)
- **内存分析**: 任务管理器 / `tracemalloc`
- **人工回归**: 手动执行测试用例清单

## 5. 交付物
- 优化后的源代码
- 更新的单元测试套件 (`tests/`)
- 性能对比报告
